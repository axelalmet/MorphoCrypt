function EvolveShapeWithUnbuckledExtensibleRod
% Set the parameters
kf = 0.01; % Dimensional foundational stiffness
h = 0.015; % Thickness of the rod cross section
w = 0.01; % Width of the rod cross section
L0 = 0.125; % Dimensional length of the rod
L = 1;
K = 12*kf*L0^4/(w*h^3);
dt = 0.1; % Time step
Es = 1; % stretching stiffness

% Get the initial solution from AUTO
solData = load('../../../../Data/planarmorphorodsinextkf0p01L1sol_1');
% solData = load('../../../Data/seashellsK50L1sol_1');

solFromData.x = solData(:,1)';
solFromData.y = solData(:,[2, 5])';

% % Define the Wnt function
W = @(S, width) exp(-((S)./width).^2);

parameters.W = W;

eta = 1.0/24; % Growth timescale (24 hours)
etaF = eta^(-1);

g = 1;

parameters.g = g;
parameters.currentArcLength = solFromData.y(1,:);
parameters.K = K;% Foundation stiffness
parameters.L = L; % Rod length
parameters.nu = 10*etaF*eta; % Foundation relaxation timescale
parameters.dt = dt; % Time step
parameters.mu = mu;
parameters.Es = Es;
parameters.Ks = Es;

% Iterate over different gradient widths
sigmaValues = 1:6;

for k = 1:length(sigmaValues)
    
    sigma = sigmaValues(k)*w/L0; % "Width" of Wnt gradient
    % sigma = 0.005;
    
    parameters.sigma = sigma;
    
    % Solve the initial bvp to obtain a structure for the first solution.
    SOld = solFromData.x;
    
    % Initialise growth
    firstGamma = 1 + dt*W(SOld, sigma);
    % firstGamma = 1 + dt*g;
    parameters.gamma = firstGamma;
    
    solFromData.y(2,:) = (1 - firstGamma)./firstGamma;
    
    % Initialise foundation shape
    parameters.P = SOld;
    
    % Define the ODEs and BCs
    DerivFun = @(x, M) UnbuckledExtensibleRodWithRemodellingFoundationOdes(x, M, solFromData, parameters);
    
    % Set the boundary conditions
    % BcFun = @(Ml, Mr) UnbuckledExtensibleRodClampedBCs(Ml, Mr, parameters);
    BcFun = @(Ml, Mr) UnbuckledExtensibleRodSpringBCs(Ml, Mr, parameters);
    
    maxPoints = 1e6;
    
    tic
    % Set the tolerances and max. number of mesh points
    solOptions = bvpset('RelTol', 1e-4,'AbsTol', 1e-4, 'NMax', maxPoints, 'Vectorized', 'On');
    
    % Solve the system.
    numSol = bvp4c(DerivFun, BcFun, solFromData, solOptions);
    
    toc
    
    initSol = numSol;
    
    % Update the initial data
    POld = interp1(solFromData.x, parameters.P, initSol.x);
    XOld = initSol.y(1,:);
    parameters.P = POld + parameters.dt*parameters.nu.*(XOld - POld);
    
    parameters.gamma = 1 + dt*W(XOld, sigma);
    
    parameters.V = cumtrapz(initSol.x, parameters.gam
    
    TMax = 5.0;
    times = 0:dt:TMax;
    numSols = length(times);
    
    % Initialise the solutions
    Sols = cell(numSols, 1);
    
    % First non-trivial solution
    Sols{1} = [initSol.x; initSol.y; parameters.P; parameters.gamma.*ones(1, length(initSol.x)); (parameters.gamma - 1)./dt; parameters.V];
    
    % Update the solutions in time
    
    solOld = initSol;
    
    tic
    for i = 2:numSols
        
        parameters.t = times(i);
        
        % Update the solution
        [solNew, gammaNew, KNew, PNew, VNew] = UpdateUnbuckledExtensibleRodPreSloughingSolution(solOld, parameters, solOptions);
        
        %     Update the incremental growth
        gammaOld = parameters.gamma;
        gammaInc = (gammaNew - gammaOld)./(dt*gammaOld);
        gammaIncremental = gammaInc;
        gammaIncremental = interp1(solOld.y(1,:), gammaInc, solNew.y(1,:));
        
        % Update gamma to the new mesh
        parameters.gamma = interp1(solOld.x, gammaNew, solNew.x);
        %     parameters.gamma = gammaNew;
        
        % Update the foundation shape
        parameters.P = interp1(solOld.x, PNew, solNew.x);
        
        % Update the velocity
        parameters.V = interp1(solOld.x, VNew, solNew.x);
        
        solOld = solNew;
        
        %         Sols{i} = [solOld.x; solOld.y; gammaIncremental];
        Sols{i} = [solOld.x; solOld.y; parameters.P; parameters.gamma.*ones(1, length(solOld.x)); gammaIncremental; parameters.V];
        
    end
    
    toc
    
    % Save the solutions
    outputDirectory = '../../../Solutions/UnbuckledRod/';
    outputValues = ['Es_1_nu_10_kf_0p01_L0_0p125_sigma_current_',num2str(sigmaValues(k)),'w_presloughing_T_5'];
    save([outputDirectory, 'sols_', outputValues, '.mat'], 'Sols') % Solutions
    save([outputDirectory, 'times_', outputValues, '.mat'], 'times') % Times
    save([outputDirectory, 'parameters_', outputValues, '.mat'], 'parameters') % Times
    
end

